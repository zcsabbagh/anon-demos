"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.raceAgainstDeadline = raceAgainstDeadline;
const time_1 = require("./time");
async function raceAgainstDeadline(cb, deadline) {
    let timer;
    return Promise.race([
        cb().then((result) => {
            return { result, timedOut: false };
        }),
        new Promise((resolve) => {
            const kMaxDeadline = 2147483647; // 2^31-1
            const timeout = (deadline || kMaxDeadline) - (0, time_1.monotonicTime)();
            timer = setTimeout(() => resolve({ timedOut: true }), timeout);
        }),
    ]).finally(() => {
        clearTimeout(timer);
    });
}
